<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<body>
    <div style="margin-top: 0.3%;">
        <button onclick="toMainPage()">Назад</button>
    </div>

    <div id="container" style="width:100%; height:900px;"></div>

    <hr>

    <div id="pie" style="width: 45%; height: 300px; margin-left: 1.5%;"></div>

    <details style="cursor: pointer; margin-top: 2%;">
        <summary>Карты и их средний онлайн</summary>

        <div th:each="map, state : ${maps}" style="margin-left: 1.5%; width:30%">
            <h3
                th:text="'#' + ${state.count} + '    ' + ${map.map} + ' (' + ${map.online} + ' игроков в среднем) в ' + ${map.records} + ' записях'">
            </h3>
            <hr>
        </div>
    </details>

</body>

<script src="/index.js"></script>
<script src="https://cdn.anychart.com/releases/8.13.0/js/anychart-base.min.js" type="text/javascript"></script>

<script>
    function drawGraph(data) {
        document.getElementById("container").innerHTML = "";
        var chart = anychart.line();
        var series = chart.line(data);
        chart.container("container");
        chart.title("Средний онлайн поминутно");
        chart.draw();
    }

    function drawPieGraph(data) {
        document.getElementById("pie").innerHTML = "";
        var chart = anychart.pie(data);
        chart.container("pie");
        chart.title("Топ карт");
        chart.draw();
    }

    function isNumberKey(e) {
        var charCode = (e.which) ? e.which : e.keyCode;

        if (charCode > 31 && (charCode < 48 || charCode > 57))
            return false;

        return true;
    }

    /*
    function callback() {
        let amount = Number(document.getElementById("mapsAmount").value);

        if(amount >= 15) {
            alert("Число слишком большое");
            return;
        } else if(amount < 1) {
            alert("Число слишком маленькое");
            return;
        }

        getPieData(amount);
    }
    */

    async function getData() {
        let data = [];

        let resposne = await fetch("http://localhost:8080/timestatsdata");
        if (resposne.ok) {
            let json = await resposne.json();

            for (var i = 0; i < json.length; i++) {
                let jsonEntry = json[i];

                let obj = {
                    x: jsonEntry.time,
                    value: jsonEntry.online
                };
                data.push(obj);
            }

            drawGraph(data);
        } else {
            alert(resposne.status);
        }
    }

    async function getPieData(mapsAmount) {
        let data = [];

        let resposne = await fetch("http://localhost:8080/mapstatsdata?count=" + mapsAmount);
        if (resposne.ok) {
            let json = await resposne.json();

            for (var i = 0; i < json.length; i++) {
                let jsonEntry = json[i];

                let obj = {
                    x: jsonEntry.map,
                    value: jsonEntry.online
                };
                data.push(obj);
            }

            drawPieGraph(data);
        } else {
            alert(resposne.status);
        }
    }

    getData();
    getPieData(10);
</script>

</html>
