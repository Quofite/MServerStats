<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<body>

    <h2 th:text="${hostname}"></h2>
    <div th:text="${address}" style="margin-top: -1%;" id="addInfo"></div>
    <button onclick="toMainPage()">На главную</button>
    <hr style="width: 23%; margin-left: 0;">

    <div>
        <div th:text="'Игроков в среднем: ' + ${averagePlayers}"></div>
        <div th:text="'Пиковый онлайн за все время: ' + ${maxPlayers}"></div>
        <hr style="width: 23%; margin-left: 0;">

        <div> Самая частая карта на сервере:
            <a th:href="${adminsFavouriteMapLink}" target="_blank" th:text="${adminsFavouriteMap}"></a>
            <div
                th:text="${adminsFavMapRecords} + ' записей об этой карте на сервере (' + ${adminsFavMapPercentage} +  '% от всего времени сервера) или ' + ${adminsFavouriteMapTime}">
            </div>
            <div th:text="${adminsFavMapAvgOnline} + ' игроков в среднем на этой карте'"></div>
        </div><br>

        <div id="mapsOnline" style="width: 45%; height: 300px; margin-left: 1.5%;"></div>

        <div> Любимая карта игроков (вне зависимости от количества записей):
            <a th:href="${playersFavMapLink}" target="_blank" th:text="${playersFavMap}"></a>
            <div th:text="${playersFavMapAvgOnline} + ' игроков в среднем на этой карте'"></div>
            <div
                th:text="${playersFavMapRecords} + ' записей об этой карте на сервере (' + ${playersFavMapPercentage} +  '%) или ' + ${playersFavMapTime}">
            </div>
        </div>

        <hr style="width: 23%; margin-left: 0;">

        <div th:text="'День максимальной посещаемости сервера: ' + ${maxDailyAverageDay}"></div>
        <div th:text="'Среднее кол-во игроков в этот день: ' + ${maxDailyAverage}"></div>
        <div th:text="'Пиковый онлайн в этот день: ' + ${maxPlayersInMaxDailyAverage}"></div>
        <div th:text="'Карта(-ы): ' + ${maxPlayersInMaxDailyAverageMaps}"></div>
    </div>

    <hr style="width: 23%; margin-left: 0;">

    <div>
        <div th:text="'Понедельник: ' + ${mondayData}"></div>
        <div th:text="'Вторник: ' + ${tuesdayData}"></div>
        <div th:text="'Среда: ' + ${wednesdayData}"></div>
        <div th:text="'Четверг: ' + ${thursdayData}"></div>
        <div th:text="'Пятница: ' + ${fridayData}"></div>
        <div th:text="'Суббота: ' + ${saturdayData}"></div>
        <div th:text="'Воскресенье: ' + ${sundayData}"></div>
    </div>

    <hr style="width: 23%; margin-left: 0;">

    <div id="container" style="width:100%;height:900px;"></div>
    <div id="avgOnline" style="width:100%;height:900px;margin-top: 2%;"></div>

</body>
<script src="/index.js"></script>
<script src="https://cdn.anychart.com/releases/8.13.0/js/anychart-base.min.js" type="text/javascript"></script>

<!-- Chart code -->
<script type="module">
    var maxAverageOnline = 0.0;
    var onlineRateColorScheme = ["#8b0000", "#ffd700", "#008000", "#4169e1"];
    var serverId = new URLSearchParams(document.location.search).get('id');

    function drawGraph(data) {
        var chart = anychart.column();
        var series = chart.column(data);

        series.fill(function () {
            if (this.value >= 0.8 * maxAverageOnline) {
                return onlineRateColorScheme[3];
            } else if (this.value <= 0.2 * maxAverageOnline) {
                return onlineRateColorScheme[0];
            } else if ((this.value > 0.2 * maxAverageOnline) && (this.value <= 0.5 * maxAverageOnline)) {
                return onlineRateColorScheme[1];
            }

            return onlineRateColorScheme[2];
        });

        series.listen("pointClick", (e) => {
            window.open("http://localhost:8080/details?id=" + serverId + "&date=" + e.point.get("x"));
        });

        chart.container("container");
        chart.title("Средний онлайн в день");
        chart.draw();
    }

    function drawAvgOnlineGraph(data) {
        var chart = anychart.line();
        var series = chart.line(data);
        chart.container("avgOnline");
        chart.title("Средний онлайн поминутно");
        chart.draw();
    }

    function drawMapsOnlineGraph(data) {
        var chart = anychart.pie(data);
        chart.container("mapsOnline");
        chart.title("Любимые карты игроков (от 288 записей)");
        chart.draw();
    }

    async function getData() {
        let data = [];  // objects array to be returned

        let response = await fetch("http://localhost:8080/graph?id=" + serverId);
        if (response.ok) {
            let json = await response.json();
            maxAverageOnline = json[0].compareOnline;

            for (var i = 0; i < json.length; i++) {
                let jsonEntry = json[i];
                let date = jsonEntry.day + "." + jsonEntry.month + "." + jsonEntry.year;

                let obj = {
                    x: date,
                    value: jsonEntry.online
                };
                data.push(obj);
            }

            drawGraph(data);

        } else {
            alert(response.status);
        }
    }

    async function getAvgOnlineData() {
        let data = [];

        let response = await fetch("http://localhost:8080/timestatsdata?id=" + serverId);
        if (response.ok) {
            let json = await response.json();
            maxAverageOnline = json[0].compareOnline;

            for (var i = 0; i < json.length; i++) {
                let jsonEntry = json[i];

                let obj = {
                    x: jsonEntry.time,
                    value: jsonEntry.online
                };
                data.push(obj);
            }

            drawAvgOnlineGraph(data);

        } else {
            alert(response.status);
        }
    }

    async function getMapsOnlineData(mapsAmount) {
        let data = [];

        let response = await fetch("http://localhost:8080/mapstatsdata?id=" + serverId + "&maps=" + mapsAmount);
        if (response.ok) {
            let json = await response.json();
            maxAverageOnline = json[0].compareOnline;

            for (var i = 0; i < json.length; i++) {
                let jsonEntry = json[i];

                if (jsonEntry.map !== "default") {
                    let obj = {
                        x: jsonEntry.map,
                        value: jsonEntry.online
                    };
                    data.push(obj);
                }
            }

            drawMapsOnlineGraph(data);

        } else {
            alert(response.status);
        }
    }

    document.getElementById("addInfo").innerHTML += (" / id: " + serverId);
    getData();
    getAvgOnlineData();
    getMapsOnlineData(10);


</script>


</html>
