<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>

<body>

  <h2 th:text="${hostname}"></h2>
  <button onclick="toMainPage()">На главную</button>
  <hr>

  <form name="server">
    <label for="servers"> Сервер: </label>
    <select name="servers" id="servers">
      <option th:each="server : ${servers}" th:value="${server.mid}" th:text="${server.hostname}"></option>
    </select>
  </form>

  <button onclick="serverChosen()">Добавить</button>

  <form name="viewForm">
    <label for="diagram">Диаграмма</label>
    <input type="radio" id="diagram" name="view">
    <label for="linear">Линейчатый график</label>
    <input type="radio" id="linear" name="view" checked>
  </form>

  <button onclick="loadData()">Сравнить</button>

  <div id="container" style="width:100%;height:900px;"></div>
  <div id="legend" style="display:flex;"></div>
</body>

<script src="./index.js"></script>
<script src="https://cdn.anychart.com/releases/8.13.0/js/anychart-base.min.js" type="text/javascript"></script>

<script>
  var view = "linear";
  const colors = ["#00cc99", "#006699", "#ff0000", "#ffd700", "#8b008b", "#00ff00", "#0000ff", "#d2691e", "#00ffff"];
  const serverMenu = document.server.servers;
  var serversArraySC = "";
  var serversArray = [];

  function serverChosen() {
    if (serversArray.length > 9) {
      alert("Достигнут максимум серверов для сравнения");
      return;
    }

    const server = serverMenu.options[serverMenu.selectedIndex];
    var serverName = server.text;
    var serverId = server.value;

    serversArraySC += (serverId + ";");
    serversArray.push(serverName);
  }

  function drawGraphs(data) {
    document.getElementById("container").innerHTML = "";
    document.getElementById("legend").innerHTML = "";

    var chart;
    if (view === "diagram") {
      chart = anychart.column();

      for (var i = 0; i < data.length; i++) {
        var series = chart.column(data[i]);
        series.normal().fill(colors[i]);
      }
    } else {
      chart = anychart.line();

      for (var i = 0; i < data.length; i++) {
        var series = chart.line(data[i]);

        series.normal().stroke(colors[i], 1);
        series.hovered().stroke(colors[i], 2);
        series.selected().stroke(colors[i], 4);
      }
    }

    chart.container("container");
    chart.title("Средний онлайн ежедневно");

    var legend = anychart.standalones.legend();
    var legendItems = [];

    for (var i = 0; i < data.length; i++) {
      var item = {
        text: serversArray[i],
        iconType: "square",
        iconFill: {color: colors[i]}
      };

      legendItems.push(item);
    }

    legend.items(legendItems);
    legend.container("legend");
    legend.draw();

    chart.draw();
  }

  async function loadData() {

    if (document.getElementById("diagram").checked) {
      view = "diagram";
    } else {
      view = "linear";
    }

    var response = await fetch("http://localhost:8080/comparedata?servers=" + serversArraySC);

    if (response.ok) {
      var responseBody = await response.json();

      let data = [];

      for (var i = 0; i < responseBody.length; i++) {
        let serverData = responseBody[i];
        let serverDataHandled = [];

        for (var j = 0; j < serverData.length; j++) {
          let jsonEntry = serverData[j];

          let x = jsonEntry.day + "." + jsonEntry.month + "." + jsonEntry.year;
          let obj = {
            x: x,
            value: jsonEntry.online
          };

          serverDataHandled.push(obj);
        }

        data.push(serverDataHandled);
      }

      drawGraphs(data);
    } else {
      alert("Словил маслину с кодом " + response.status);
    }
  }

</script>

</html>
